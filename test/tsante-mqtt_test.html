<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>tsante-mqtt test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../tsante-mqtt.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <tsante-mqtt>
          <tsante-mqtt-subscriber topic="terminal/#"></tsante-mqtt-subscriber>
          <tsante-mqtt-publisher topic="terminal/hello"></tsante-mqtt-publisher>
        </tsante-mqtt>
      </template>
    </test-fixture>
    <div id="mocha"></div>
    <script>

      suite('tsante-mqtt', function() {
        test('instantiating the element works', function() {
          var element = fixture('basic');
          assert.equal(element.is, 'tsante-mqtt');
        });

        test('the component is not connected', () => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          expect(element.connected).to.be.false;
          expect(subscriber.subscribed).to.be.false;
        });

        test('connect to ws://test.mosquitto.org:8080/', (done) => {
          const element = fixture('basic');
          element.addEventListener('tsante-mqtt-connect', (evt) => {
            expect(evt.detail.status).to.be.true;
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('if already connected, on connect the component should throw an error', (done) => {
          const element = fixture('basic');
          let count = 0;
          element.addEventListener('tsante-mqtt-connect', (evt) => {
            if(!count) {
              expect(evt.detail.status).to.be.true;
              element.connect();
            }
          });
          element.addEventListener('tsante-mqtt-error', (evt) => {
            expect(evt.detail).to.be.equal('AMQJS0011E Invalid state already connected.');
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('disconnect', (done) => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          let count = 0;
          element.addEventListener('tsante-mqtt-connect', (evt) => {
            if(!count) {
              count++;
              expect(evt.detail.status).to.be.true;
              element.disconnect();
            } else {
              expect(evt.detail.status).to.be.false;
              expect(element.connected).to.be.false;
              done();
            }
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('if already disconnected, on disconnect the component should throw an error', (done) => {
          const element = fixture('basic');
          let count = 0;
          element.addEventListener('tsante-mqtt-connect', (evt) => {
            if(!count) {
              count++;
              expect(evt.detail.status).to.be.true;
              element.disconnect();
            } else {
              element.disconnect();
            }
          });
          element.addEventListener('tsante-mqtt-error', (evt) => {
            expect(evt.detail).to.be.equal('AMQJS0011E Invalid state not connecting or connected.');
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('subscriber should automatically subscribe on connect', (done) => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          subscriber.addEventListener('tsante-mqtt-subscribed', (evt) => {
            expect(evt.detail.status).to.be.true;
            expect(evt.detail.topic).to.be.equal('terminal/#');
            expect(subscriber.subscribed).to.be.true;
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('subscriber should automatically be unsubscribed on disconnect', (done) => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          let count = 0;
          subscriber.addEventListener('tsante-mqtt-subscribed', (evt) => {
            if(!count) {
              count++;
              expect(evt.detail.status).to.be.true;
              setTimeout(element.disconnect(), 200);
            } else {
              expect(evt.detail.status).to.be.false;
              expect(evt.detail.topic).to.be.equal('terminal/#');
              expect(subscriber.subscribed).to.be.false;
              done();
            }
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('publisher should automatically on connect', (done) => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          const publisher = element.querySelector('tsante-mqtt-publisher');
          publisher.payload = 'world';
          element.addEventListener('tsante-mqtt-delivered', (evt) => {
            expect(evt.detail.payload).to.be.equal('world');
            expect(evt.detail.topic).to.be.equal('terminal/hello');
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('subscriber should receive the published message', (done) => {
          const element = fixture('basic');
          const subscriber = element.querySelector('tsante-mqtt-subscriber');
          const publisher = element.querySelector('tsante-mqtt-publisher');
          let count = 0;
          publisher.payload = 'world';
          element.addEventListener('tsante-mqtt-received', (evt) => {
            console.log(count++);
            expect(evt.detail.payload).to.be.equal('world');
            expect(evt.detail.topic).to.be.equal('terminal/hello');
            done();
          });
          element.host = 'ws://test.mosquitto.org:8080/';
        });

        test('connection to wss://test.mosquitto.org:8081/', (done) => {
          const element = fixture('basic');
          element.addEventListener('tsante-mqtt-connect', (evt) => {
            expect(evt.detail.status).to.be.true;
            done();
          });
          element.host = 'wss://test.mosquitto.org:8081/';
        });
      });
    </script>
  </body>
</html>
