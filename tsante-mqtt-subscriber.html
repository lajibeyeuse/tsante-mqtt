<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="tsante-mqtt-subscriber">
  <script>
    /**
     * `tsante-mqtt-subscriber`
     * 
     * A component to subscribe to a topic of a mqtt server. The component
     * must be a children of `tsante-mqtt` component
     * 
     * example :
     * 
     * ```
     * <tsante-mqtt id="mqtt" host="ws://test.mosquitto.org:8080/" >
     *   <tsante-mqtt-subscriber topic="terminal/#"></tsante-mqtt-subscriber>
     * </tsante-mqtt>
     * ```
     */
    class TsanteMqttSubscriber extends Polymer.Element {
      static get is() {
        return 'tsante-mqtt-subscriber'
      }

      static get properties() {
        return {
          /**
           * topic to publish to
           * @type {String}
           */
          topic: {
            type: String,
            value: "#",
            observer: '_topicChanged'
          },

          /**
           * set when subscribe is sucessful
           * @type {Boolean}
           */
          subscribed: {
            type: Boolean,
            value: false,
            readOnly: true,
            reflectToAttribute: true,
          },
        }
      }

      connectedCallback() {
        super.connectedCallback()
          if (this.parentElement.tagName !== 'tsante-mqtt'.toUpperCase()) {
            console.error('tsante-mqtt-subscriber must have a tsante-mqtt parent');
          }
          // when the parent is connected then subscribe to the topic
          this.parentElement.addEventListener('tsante-mqtt-connect', (evt) => {
            if (evt.detail.status) {
              this._subscribe();
            } else if (this.subscribed) {
              this._setSubscribed(false);
              this.dispatchEvent(new CustomEvent('tsante-mqtt-subscribed', {
                detail: {
                  topic: this.topic,
                  status: false
                }
              }))
            }
          });
        }

        /**
         * When topic change, if the component is subscribed
         * then unsubscribe the old topic before subscribing to the new one
         *
         * @method _topicChanged
         * @param  {String}  newValue the new topic to subscribe to
         * @param  {String}  oldValue the previous topic
         */
        _topicChanged(newValue, oldValue) {
          if (newValue !== oldValue) {
            if (oldValue && this.subscribed) {
              this.unsubscribe(oldValue);
              this.addEventListener('tsante-mqtt-subscribed', this._subscribe);
            } else {
              this._subscribe();
            }
          }
        }

        /**
         * subscribe to the topic
         * @method _subscribe
         */
        _subscribe() {
          if (this.parentElement.connected && !this.subscribed) {
            this.removeEventListener('tsante-mqtt-subscribed', this._subscribe);
            this.parentElement.client.subscribe(this.topic, {
              onSuccess: this._onSubscribe.bind(this),
              onFailure: this._onSubscribeFail.bind(this),
              invocationContext: {
                topic: this.topic
              },
            });
          }
        }

        /**
         * fired when subscribed to a topic
         *
         * example of `evt.detail` :
         *
         * ```
         * {
         *    topic: "terminal/hello",
         *    status: true
         * }
         * ```
         *
         * @event tsante-mqtt-subscribed
         * @param  {String}  topic the topic on which we subscribe
         * @param  {Boolean}  status the subscription status
         */
        _onSubscribe(evt) {
          this._setSubscribed(true);
          this.dispatchEvent(new CustomEvent('tsante-mqtt-subscribed', {
            detail: {
              topic: evt.invocationContext.topic,
              status: true
            }
          }))
        }


        _onSubscribeFail(evt) {
          this._setSubscribed(false);
          this._onError(evt);
        }

        /**
         * unsubscribe of the given topic
         * @method unsubscribe
         * @param  {String}  topic the topic to unsubscribe (default this.topic )
         */
        unsubscribe(topic = this.topic) {
          this.parentElement.client.unsubscribe(topic, {
            onSuccess: this._onUnsubscribe.bind(this),
            onFailure: this._onUnsubscribeFail.bind(this),
            invocationContext: {
              topic: topic
            },
          });
        }

        /**
         * on successful unsubscribe send a `tsante-mqtt-subscribed` event
         * @method _onUnsubscribe
         * @param  {Object} evt
         */
        _onUnsubscribe(evt) {
          this._setSubscribed(false)
          this.dispatchEvent(new CustomEvent('tsante-mqtt-subscribed', {
            detail: {
              topic: evt.invocationContext.topic,
              status: false
            }
          }))
        }

        _onUnsubscribeFail(evt) {
          this._setSubscribed(true);
          this._onError(evt);
        }

        /**
         * fired on subscription/unsupscription error
         * @event tsante-mqtt-error
         * @param  {String}  message the error message
         */
        _onError(err) {
          this.dispatchEvent(new CustomEvent('tsante-mqtt-error', {
            detail: err.message
          }))
        }
    }

    window.customElements.define(TsanteMqttSubscriber.is, TsanteMqttSubscriber)
  </script>
</dom-module>