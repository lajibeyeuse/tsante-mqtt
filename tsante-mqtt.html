<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="./tsante-mqtt-subscriber.html">
<link rel="import" href="./tsante-mqtt-publisher.html">
<link rel="import" href="./mqttws31.html">

<dom-module id="tsante-mqtt">
  <script>
    /**
     * `tsante-mqtt`
     * 
     * A MQTT component
     * 
     * example :
     * 
     * ```
     * <tsante-mqtt host="ws://test.mosquitto.org:8080/" >
     *   <tsante-mqtt-subscriber topic="terminal/hello"></tsante-mqtt-subscriber>
     *   <tsante-mqtt-publisher topic="terminal/hello" payload="polymer" ></tsante-mqtt-subscriber>
     * </tsante-mqtt>
     * ```
     * 
     * @customElement
     * @Polymer
     * @extends {Polymer.Element}
     * @demo demo/index.html
     */
    class TsanteMqtt extends Polymer.Element {
      static get is() {
        return "tsante-mqtt"
      }

      static get properties() {
        return {
          /**
           * the url of the server
           *
           * by exapmple :
           * `ws://test.mosquitto.org:8080/`
           *
           * @type {String}
           */
          host: {
            type: String,
            value: '',
          },

          /**
           * clientID
           *
           * the clientID is used by the server to retrieve the previous session
           *
           * @type {String}
           */
          clientID: {
            type: String,
            value: () => Math.random().toString(36).replace(/[^a-z]+/g, ''),
          },

          /**
           * username
           * @type {String}
           */
          username: {
            type: String,
          },

          /**
           * password
           * @type {String}
           */
          password: {
            type: String,
          },

          /**
           * timeout of the connection in seconds
           * @type {Number}
           */
          timeout: {
            type: Number,
            value: 10,
          },

          /**
           * retry connect after a period
           * the time is in seconds
           * @type {Number}
           */
          retry: {
            type: Number,
            value: 0,
          },

          /**
           * if true(default) the client and server persistent state
           * is deleted on successful connect.
           *
           * @type {Boolean}
           */
          cleanSession: {
            type: Boolean,
            value: true,
          },

          /**
           * message sent by the server when the client disconnects abnormally.
           *
           *
           * @type {String}
           */
          willMessage: {
            type: Object,
            value: function () {
              return {};
            },
          },

          /**
           * The mqtt client
           * @type {Object}
           */
          client: {
            type: Object,
            notify: true,
          },

          /**
           * the connection status
           * @type {Boolean}
           */
          connected: {
            type: Boolean,
            value: false,
            readOnly: true,
            reflectToAttribute: true,
            observer: '_connectedChanged'
          }
        }
      }

      static get observers() {
        return [
          '_initializeClient(host,clientID)',
          'connect(username, password)',
        ]
      }

      connectedCallback() {
        super.connectedCallback()
        this.connect()
      }

      disconnectedCallback() {
        super.disconnectedCallback()
        this.disconnect()
      }

      _initializeClient(host, clientID) {
        if(!host) return;
        if (this.connected && this.client) {
          this.disconnect();
        }
        this.client = new Paho.MQTT.Client(this.host, this.clientID);
        this.client.onConnectionLost = this._onConnectionLost.bind(this);
        this.client.onMessageArrived = this._onMessageArrived.bind(this);
        this.client.onMessageDelivered = this._onMessageDelivered.bind(this);
        this.connect();
      }

      _onConnect() {
        this._setConnected(true);
      }

      /**
       * sent when the connection fails
       * @event tsante-mqtt-connect-error
       * @param  {String} message message of the error
       * @param  {Boolean} status status of the connection
       */
      _onFail() {
        this._setConnected(false);
        this.dispatchEvent(new CustomEvent('tsante-mqtt-connect-error', {
          detail: {
            status: this.connected,
            message: 'fail to connect',
          }
        }))
        this._retry();
      }

      _retry() {
        if (this.retry) {
          setTimeout(this.connect.bind(this), this.retry * 1000);
        }
      }

      /**
       * Fired when the status of the connection change
       *
       * example of `evt.detail` :
       *
       * ```
       * { status: true }
       * ```
       *
       * @event tsante-mqtt-connect
       * @param {Boolean} status the status of the connection
       */
      _connectedChanged() {
        this.dispatchEvent(new CustomEvent('tsante-mqtt-connect', {
          detail: {
            status: this.connected
          }
        }))
      }

      _onConnectionLost(msg) {
        this._setConnected(false);
        this._retry();
      }

      /**
       * fired when a message is read
       *
       * example of the `evt.detail` :
       *
       * ```
       * {
       *   topic: "terminal/hello",
       *   payload: "polymer"
       * }
       * ```
       *
       * @event tsante-mqtt-received
       * @param  {String} topic topic of the received message
       * @param  {String} payload content of the received message
       */
      _onMessageArrived(msg) {
        this.dispatchEvent(new CustomEvent('tsante-mqtt-received', {
          detail: {
            topic: msg.destinationName,
            payload: msg.payloadString
          }
        }))
      }

      /**
       * called when a message has been delivered. All processing that this
       * Client will ever do has been completed.
       *
       * @method _onMessageDelivered
       * @param  {Object}            msg the delivered message
       */
      _onMessageDelivered(msg) {
        /**
         * fired when a message has been delivered
         *
         * example of `evt.detail` :
         * ```
         * {
         *    topic: 'terminal/hello',
         *    payload: 'world'
         * }
         * ```
         *
         * @event tsante-mqtt-delivered
         * @param {String} topic the topic
         * @param {String} payload the content of the message
         */
        this.dispatchEvent(new CustomEvent('tsante-mqtt-delivered', {
          detail: {
            topic: msg.destinationName,
            payload: msg.payloadString
          }
        }))
      }

      /**
       * open the connection to the server
       *
       * @method connect
       * @param  {String} username the login to use
       * @param  {String} password the password to use
       */
      connect(username, password) {
        if (!this.client) return;
        this._debouncer = Polymer.Debouncer.debounce(
          this._debouncer, // initially undefined
          Polymer.Async.timeOut.after(100),
          () => {  
            const connectOption = {
              onSuccess: this._onConnect.bind(this),
              onFailure: this._onFail.bind(this),
              timeout: this.timeout,
              cleanSession: this.cleanSession,
            };
            if (this.username || username) {
              connectOption.userName = this.username || username;
            }
            if (this.password || password) {
              connectOption.password = this.password || password;
            }

            try {
              this.client.connect(connectOption);
            } catch (err) {
              this._onError(err.message);
            }
          },
        )
      }

      /**
       * disconnect the client
       * @method disconnect
       */
      disconnect() {
        try {
          this.client.disconnect();
          this._setConnected(false);
        } catch (err) {
          this._onError(err.message);
        }
      }

      /**
       * fired when an error occurs while connect or disconnect
       *
       * example of error :
       *  - "AMQJS0011E Invalid state not connecting or connected."
       *  - "AMQJS0011E Invalid state already connected."
       *
       * @event tsante-mqtt-error
       * @param  {String} errMessage message of the error
       */
      _onError(errMessage) {
        if(this._debouncer) { this._debouncer.flush() }
        this.dispatchEvent(new CustomEvent('tsante-mqtt-error', {
          detail: errMessage
        }));
      }
    }

    window.customElements.define(TsanteMqtt.is, TsanteMqtt)
  </script>
</dom-module>