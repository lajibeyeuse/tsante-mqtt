<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./mqttws31.html">

<!--
`tsante-mqtt`
A MQTT component

@demo demo/index.html
-->

<dom-module id="tsante-mqtt">

  <script>
    Polymer({

      is: 'tsante-mqtt',

      properties: {
        /**
         * FDQN or IP of the mqtt server
         * @type {String}
         */
        host: {
          type: String,
        },

        /**
         * clientID
         * @type {String}
         */
        clientID: {
          type: String,
          value: function() {
            return Math.random().toString(36).replace(/[^a-z]+/g, '');
          }
        },

        /**
         * username
         * @type {String}
         */
        username: {
          type: String,
        },

        /**
         * password
         * @type {String}
         */
        password: {
          type: String,
        },

        /**
         * timeout of the connection in seconds
         * @type {Number}
         */
        timeout: {
          type: Number,
          value: 30,
        },

        /**
         * if true(default) the client and server persistent state
         * is deleted on successful connect.
         *
         * @type {Boolean}
         */
        cleanSession: {
          type: Boolean,
          value: false,
        },

        /**
         * sent by the server when the client disconnects abnormally.
         * @type {String}
         */
        willMessage: {
          type: Object,
          value: function() { return {}; },
        },

        client: {
          type: Object,
          notify: true,
        },

        connected: {
          type: Boolean,
          value:false,
          readOnly: true,
          reflectToAttribute: true,
          observer: '_connectedChanged'
        }
      },

      attached: function() {
        if(this.host) {
          this.client = new Paho.MQTT.Client(this.host, this.clientID);
          this.client.onConnectionLost = this._onConnectionLost.bind(this);
          this.client.onMessageArrived = this._onMessageArrived.bind(this);
          this.client.onMessageDelivered = this._onMessageDelivered.bind(this);
          const connectOption = {
            onSuccess: this._onConnect.bind(this),
            onFailure: this._onFail.bind(this),
            timeout: this.timeout,
            cleanSession: this.cleanSession,
          };
          if(this.username) { connectOption.userName = this.username; }
          if(this.password) { connectOption.password = this.password; }

          this.client.connect(connectOption);
        }
      },

      _onConnect: function() {
        this._setConnected(true);
        console.log('connected');
      },

      _onFail: function() {
        this._setConnected(false);
        console.error('fail to connect');
        throw new Error('fail to connect')
      },

      _connectedChanged: function() {
        this.fire('tsante-mqtt-connect', { status: this.connected });
      },

      _onConnectionLost: function(msg) {
        console.log('connection lost');
      },

      _onMessageArrived: function(msg) {
        console.log("received : ", msg.destinationName, msg.payloadString );
        this.fire('tsante-mqtt-received', { topic:msg.destinationName, payload:msg.payloadString })
      },

      _onMessageDelivered: function(msg) {
        console.log("received : ", msg.destinationName, msg.payloadString );
        this.fire('tsante-mqtt-delivered', { topic:msg.destinationName, payload:msg.payloadString })
      }

    });
  </script>
</dom-module>
